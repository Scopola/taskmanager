@page
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}

<div class="row pt-1">
    <div class="col-4">
        <a asp-page="/Index">
            <img id="ukhoLogo" src="~/images/ukhologo.svg" alt="UKHO Logo" />
        </a>
    </div>
    <div class="col-8">
        <div class="row mb-2">
            <div class="col-8">
                <button id="btnMyTaskList" class="btn btn-primary">My Task List</button>
                <button id="btnTeamTasks" class="btn btn-primary">Team Tasks</button>
                <button id="btnStats" class="btn btn-primary">Statistics</button>
                <button id="btnHistorical" class="btn btn-primary">Historical Tasks</button>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-6 pr-0">
                <input id="txtGlobalSearch" type="search" class="form-text-input" placeholder="Type search term..." />
            </div>
            <div class="col-6">
                <button id="btnRefresh" type="button" class="btn btn-primary" data-toggle="popover" data-placement="bottom" data-trigger="hover" data-content="Refresh the list of tasks in both tabs, preserving selected sort options and search criteria."><span class="fas fa-sync-alt"></span></button>
                <button class="btn btn-primary dropdown" type="button" id="btnSelectStage" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">Select Stage</button>
                <button class="btn btn-primary dropdown" type="button" id="btnSelectTeam" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">Select Team</button>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4 mt-3">
    <h6>Unassigned Tasks</h6>
    <div class="card-body" style="width:100%">
        <table id="unassignedTasks" class="table-striped" style="width:100%">
            <thead>
                <tr>
                    <th>ID</th>
                    <th style="min-width: 3.6rem;">DM End</th>
                    <th style="min-width: 5.8rem;">DM End Date</th>
                    <th style="min-width: 3.9rem;">On Hold</th>
                    <th>RSDRA No.</th>
                    <th>Source Name</th>
                    <th>Workspace</th>
                    <th>Task Type</th>
                    <th>Stage</th>
                    <th>Assessor</th>
                    <th>Verifier</th>
                    <th>Team</th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var task in Model.Tasks.Where(t => string.IsNullOrEmpty(t.DbAssessmentReviewDataAssessor) && string.IsNullOrEmpty(t.DbAssessmentReviewDataVerifier)))
                {
                    <tr>
                        <td>
                            <a asp-page="DbAssessment/Review" asp-route-ProcessId="@task.ProcessId">@task.ProcessId</a>
                        </td>
                        <td>
                            @task.DaysToDmEndDate
                        </td>
                        <td>
                            @task.DmEndDate.ToShortDateString()
                        </td>
                        <td>
                            @task.DaysOnHold
                        </td>
                        <td>
                            @task.AssessmentDataRsdraNumber
                        </td>
                        <td>
                            @task.AssessmentDataSourceDocumentName
                        </td>
                        <td>
                            @task.Workspace
                        </td>
                        <td>
                            @task.TaskType
                        </td>
                        <td>
                            @task.TaskStage
                        </td>
                        <td></td>
                        <td></td>
                        <td>
                            @task.Team
                        </td>
                        <td>
                            <i class="fas fa-cog black"></i>
                        </td>
                        <td>
                            @task.TaskNote
                        </td>
                    </tr>
                }

            </tbody>
        </table>
    </div>
</div>
<div class="card mb-4 mt-3">
    <h6>In Flight Tasks</h6>
    <div class="card-body" style="width: 100%">
        <table id="inFlightTasks" class="table-striped" style="width: 100%">
            <thead>
                <tr>
                    <th>ID</th>
                    <th style="min-width: 3.6rem;">DM End</th>
                    <th style="min-width: 5.8rem;">DM End Date</th>
                    <th style="min-width: 3.9rem;">On Hold</th>
                    <th>RSDRA No.</th>
                    <th>Source Name</th>
                    <th>Workspace</th>
                    <th>Task Type</th>
                    <th>Stage</th>
                    <th>Assessor</th>
                    <th>Verifier</th>
                    <th>Team</th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var task in Model.Tasks.Where(t => !string.IsNullOrEmpty(t.DbAssessmentReviewDataAssessor) || !string.IsNullOrEmpty(t.DbAssessmentReviewDataVerifier)))
                {
                    <tr>
                        <td>
                            <a asp-page="DbAssessment/Review" asp-route-ProcessId="@task.ProcessId">@task.ProcessId</a>
                        </td>
                        <td>
                            @task.DaysToDmEndDate Days
                        </td>
                        <td>
                            @task.DmEndDate.ToShortDateString()
                        </td>
                        <td>
                            @task.DaysOnHold Days
                        </td>
                        <td>
                            @task.AssessmentDataRsdraNumber
                        </td>
                        <td>
                            @task.AssessmentDataSourceDocumentName
                        </td>
                        <td>
                            @task.Workspace
                        </td>
                        <td>
                            @task.TaskType
                        </td>
                        <td>
                            @task.TaskStage
                        </td>
                        <td>
                            @task.DbAssessmentReviewDataAssessor
                        </td>
                        <td>
                            @task.DbAssessmentReviewDataVerifier
                        </td>
                        <td>
                            @task.Team
                        </td>
                        <td>
                            <i class="fas fa-cog black"></i>
                        </td>
                        <td>
                            @task.TaskNote
                        </td>
                    </tr>
                }

            </tbody>
        </table>
    </div>
</div>
@section Scripts {

    <script>
        $(document).ready(function () {
            var unassignedTasksTable = $('#unassignedTasks').DataTable({
                "pageLength": 5,
                'sDom': 'ltipr',
                "lengthMenu": [5, 10, 25, 50],
                'columnDefs': [{
                    'targets': [12],
                    'orderable': false,
                    'searchable': false
                },
                {
                    'targets': [13],
                    'visible': false,
                    'searchable': false
                }],
                "scrollX": true,
                "ordering": true
            });
            var inFlightTasksTable = $('#inFlightTasks').DataTable({
                "pageLength": 5,
                "lengthMenu": [5, 10, 25, 50],
                'sDom': 'ltipr',
                'autoWidth': true,
                'columnDefs': [
                    {
                        'targets': [12],
                        'orderable': false,
                        'searchable': false
                    },
                    {
                        'targets': [13],
                        'visible': false,
                        'searchable': false
                    }
                ],
                "scrollX": true,
                "ordering": true
            });

            // TODO fix up in tasks note story

            //$('#inFlightTasks tbody tr').each(function (index, tr) {

            //    var row = inFlightTasksTable.row(tr);
            //    var taskNote = row.data()[13];

            //    if (taskNote.length > 0) {
            //        row.child("<b>Note: </b>" + taskNote).show();
            //        row.child().children("td").addClass("note-formatting");
            //    } else {
            //        row.child("").show();
            //    }

            //    $(tr).addClass('shown');

            //    if ($(tr).hasClass('red')) {
            //        row.child().addClass('red');
            //    } else if ($(tr).hasClass('amber')) {
            //        row.child().addClass('amber');
            //    } else if ($(tr).hasClass('black')) {
            //        row.child().addClass('black');
            //    }
            //});

            $('#txtGlobalSearch').keyup(function () {
                unassignedTasksTable.search($(this).val()).draw();
                inFlightTasksTable.search($(this).val()).draw();
            });
        });
    </script>
}
